#title listen : 소켓 대기열 생성

[wiki:man/2/listen HTML 변환문서]

{{{#!plain
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook V4.1//EN">
<chapter lang=ko>
<!-- 작성자 : yundream             -->
<!-- 작성일 : 2004/01/03           -->
<!-- 연락처 : yundream@joinc.co.kr -->

<!-- 함수 이름을 입력합니다 -->
<title>listen(2)</title>

<!-- 이건 함수에 대한 대략적인 설명이구요 -->
<para>
	소켓의 연결 대기열을 만든다.
</para>
 
<!-- 여기에 함수의 간단한 사용법이 들어갑니다 -->
<section>
	<title>사용법</title>
	<para>
		<screen>
#include &lt;sys/socket.h&gt;

int listen(int s, int backlog);
		</screen>
	</para>
</section>

<!-- 여기엔 함수의 자세한 설명 이 들어갑니다 -->
<section>
	<title>설명</title>
	<para>
		서버측 프로그램은 socket(2)함수를 이용해서 클라이언트의 연결을 받아들일 
		듣기소켓을 만들게 된다. 클라이언트의 연결은 듣기소켓을 통해서 이루어지는데 
		클라이언트는 connect(2)를 호출해서 서버에 연결을 시도하고, 3번 악수기법이 
		성공하면 서버와 완전한 연결이 만들어 진다.    
	</para>
	<para>
		만들어진 연결은 queue에 들어가게 되고 서버측에서 accept(2)를 호출하면 
		비로서 서버는 연결소켓을 만들고 만들어진 연결소켓을 이용해서 
		클라이언트와 통신하게 된다.   
	</para>
	<para>
		listen(2) 시스템호출은 SOCK_STREAM과 SOCK_SEQPACKET에만 사용된다.
	</para>
	<para>
		<emphasis>a</emphasis>는 socket(2)에 의해서 만들어진 듣기 소켓이다. 
		<emphasis>backlog</emphasis>는 연결이 대기할 수 있는 큐의 갯수이다. 
		만약 backlog에 연결이 모두 찬 상태에서 새로운 연결을 시도한다면, 
		클라이언트는 ECONNREFUSED 에러를 받게될 것이다. 만약 재전송을 지원하는 
		프로토콜을 사용한다면 에러를 무시하고 성공할 때까지 재시도를 하게 된다.  
	</para>
</section>

<!-- 함수가 되돌려주는 값이구요 -->
<section>
	<title>반환값</title>
	<para>
		성공하면 0을 리턴하고 실패했을 경우 -1을 리턴하고 <emphasis>errno</emphasis>
		를 설정한다.
	</para>
</section>

<section>
	<title>에러</title>
	<para>
		<variablelist>	
			<varlistentry>
			<term>EADDRINUSE</term>	
			<listitem>
				<para>	
					다른 소켓이 동일한 포트를 사용하고 있다.
				</para>	
			</listitem>
			</varlistentry>
			<varlistentry>
			<term>EBADF</term>	
			<listitem>
				<para>	
					<emphasis>s</emphasis>가 잘못된 소켓지정자이다.
				</para>	
			</listitem>
			</varlistentry>
			<varlistentry>
			<term>EOPNOTSUP</term>	
			<listitem>
				<para>	
					소켓이 listen을 지원하지 않는다.
				</para>	
			</listitem>
			</varlistentry>
			<varlistentry>
			<term>ENOTSOCK</term>	
			<listitem>
				<para>	
					<emphasis>s</emphasis>가 소켓이 아니다.
				</para>	
			</listitem>
			</varlistentry>
		</variablelist>	
	</para>
</section>

<!-- 마지막으로 에제 입니다                                                 -->
<!-- 여기에는 완전한 예제가 들어가 있는데, 굳이 완전한 예제를 만들필요 없이 -->
<!-- 코드 일부분만 작성해서 올려주셔도 됩니다                               --> 
<!-- "<", ">", "&" 등은 변환해 주셔야 하는데, 귀찮으시면 :-) 변환 하지 않   -->
<!-- 아도 됩니다. 제가 검사 해서 올리겠습니다                               -->
<!-- 예제에 대한 간단한 설명을 적어주셔도 되구요                            -->
<section>
	<title>예제</title>
	<para>
		<screen>
#include &lt;sys/socket.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv)
{
    int server_sockfd, client_sockfd;
    int client_len, n;
    char buf[80];
    struct sockaddr_in clientaddr, serveraddr;

    client_len = sizeof(clientaddr);

    if ((server_sockfd = socket (AF_INET, SOCK_STREAM, 0)) &lt; 0)
    {
        perror("socket error : ");
        exit(0);
    }
    bzero(&amp;serveraddr, sizeof(serveraddr));
    serveraddr.sin_family = AF_INET;
    serveraddr.sin_addr.s_addr = htonl(INADDR_ANY);
    serveraddr.sin_port = htons(atoi(argv[1]));

    bind (server_sockfd, (struct sockaddr *)&amp;serveraddr, sizeof(serveraddr));
    listen(server_sockfd, 5);

    while(1)
    {
        memset(buf, 0x00, 80);
        client_sockfd = accept(server_sockfd, (struct sockaddr *)&amp;clientaddr,
                            &amp;client_len);

        if ((n = read(client_sockfd, buf, 80)) &lt;= 0)
        {
            close(client_sockfd);
            continue;
        }
        if (write(client_sockfd, buf, 80) &lt;=0)
        {
            perror("write error : ");
            close(client_sockfd);
        }
        close(client_sockfd);
    }
}
		</screen>
		위 프로그램은 클라이언트의 메시지를 읽어서 그대로 재 전송하는 echo
		프로그램이다. 
	</para>
</section>
<section>
	<title>관련문헌</title>
	<para>
		<orderedlist>
			<listitem>
				<para>
					<ulink url="http://www.joinc.co.kr/modules.php?name=News&amp;file=article&amp;sid=57">Socket Layer</ulink>
				</para>
			</listitem>
		</orderedlist>
	</para>
</section>
</chapter>
}}}
